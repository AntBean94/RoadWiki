<template>
  <div>
    <div
      class="header pb-8 pt-5 pt-lg-8 d-flex align-items-center profile-header"
      style="
        min-height: 600px;
        background-image: url(img/theme/profile-cover.jpg);
        background-size: cover;
        background-position: center top;
      "
    >
      <b-container class="align-items-center">
        <span class="mask bg-gradient-default opacity-5"></span>
        <!-- <b-row class="justify-content-end"><BackgroundImg /></b-row> -->
      </b-container>
    </div>

    <b-container fluid class="mt--6">
      <b-card no-body class="card-profile" alt="Image placeholder" img-top>
        <b-row class="justify-content-start">
          <b-col lg="3" class="order-lg-2">
            <b-container class="card-profile-image">
              <b-row>
                <b-img :src="rqprofileURL" rounded="circle" />
              </b-row>
              <b-row class="justify-content-end"> </b-row>
            </b-container>
          </b-col>
        </b-row>

        <b-card-header
          class="text-center border-0 pt-8 pt-md-4 pb-0 pb-md-4 mb-4"
        >
          <h1 class="display-1">
            <!-- email.com -->
          </h1>
        </b-card-header>
        <b-card-body class="pt-0">
          <b-row>
            <b-col>
              <div
                class="card-profile-stats d-flex justify-content-center mt-md-5"
              ></div>
            </b-col>
          </b-row>
          <b-container>
            <!-- <hr class="my-4"> -->
            <b-row class="mb-3">
              <b-col cols="3" class="text-center" align-self="center">
                <h2>
                  <!-- <i class="ni ni-hat-3 mr-2"></i> -->
                  ÎãâÎÑ§ÏûÑ
                </h2>
              </b-col>
              <b-col>
                <b-form-input
                  :value="nickname"
                  v-model="nickname"
                ></b-form-input>
              </b-col>
            </b-row>
            <b-row class="mb-3">
              <b-col cols="3" class="text-center" align-self="center">
                <h2>
                  <!-- <i class="ni ni-hat-3 mr-2"></i> -->
                  Ï†ÑÍ≥µ
                </h2>
              </b-col>
              <b-col>
                <b-form-input value="Í∏∞Í≥ÑÍ≥µÌïô"></b-form-input>
              </b-col>
            </b-row>
            <b-row class="mb-3">
              <b-col cols="3" class="text-center" align-self="center">
                <h2>
                  <!-- <i class="ni ni-hat-3 mr-2"></i> -->
                  Î∏îÎ°úÍ∑∏
                </h2>
              </b-col>
              <b-col>
                <!-- address ÏàòÏ†ï -->
                <b-form-input :value="address"></b-form-input>
              </b-col>
            </b-row>
            <b-row class="mb-3">
              <b-col cols="3" class="text-center" align-self="center">
                <h2>
                  <!-- <i class="ni ni-hat-3 mr-2"></i> -->
                  Ìïú Ï§Ñ ÏÜåÍ∞ú
                </h2>
              </b-col>
              <b-col>
                <b-form-textarea
                  :value="introduction"
                  v-model="introduction"
                  rows="5"
                >
                </b-form-textarea>
              </b-col>
            </b-row>
            <b-row class="mb-3">
              <b-col cols="3" class="text-center" align-self="center">
                <h2>
                  <!-- <i class="ni ni-hat-3 mr-2"></i> -->
                  Í¥ÄÏã¨ Í∞úÎ∞ú Î∂ÑÏïº
                </h2>
              </b-col>
              <b-col cols="7" align-self="center">
                <b-badge
                  variant="warning"
                  class="mx-1"
                  v-for="(keyword, idx) in keywordtexts"
                  :key="idx"
                >
                  {{ keyword }}
                </b-badge>
              </b-col>
              <FlavourContent 
                class="col align-self-center pl-5 ml-5" 
                @changeFlavour="changeFlavour"
                :keywords="keywords"
              />
            </b-row>
            <b-row class="mb-3">
              <b-col cols="3" class="text-center" align-self="center">
                <h2>
                  <!-- <i class="ni ni-hat-3 mr-2"></i> -->
                  ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ
                </h2>
              </b-col>
              <b-col>
                <h3>Ïó¨Í∏∞Ïóê ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ ÌååÏùº Î™Ö</h3>
                <!-- <ProfileImg/> -->
              </b-col>
              <b-col>
                <div>
                  <b-button size="sm" @click="modalShow = !modalShow"
                    >ÏÇ¨ÏßÑüì∑</b-button
                  >

                  <b-modal v-model="modalShow" hide-footer>
                    <template #modal-title>
                      <h1>ÌîÑÎ°úÌïÑ ÏóÖÎ°úÎìú</h1>
                    </template>
                    <div>
                      <b-form-file
                        v-model="file1"
                        placeholder="Choose a file or drop it here..."
                        drop-placeholder="Drop file here..."
                      ></b-form-file>
                      <div class="mt-3">
                        Selected file: {{ file1 ? file1.name : "" }}
                      </div>
                    </div>
                    <div class="text-center">
                      <base-button
                        type="primary"
                        native-type="submit"
                        class="my-4"
                        @click="uploadHandler"
                        >ÌôïÏù∏</base-button
                      >
                    </div>
                  </b-modal>
                </div>
              </b-col>
            </b-row>
            <b-row class="mb-3">
              <b-col cols="3" class="text-center" align-self="center">
                <h2>
                  <!-- <i class="ni ni-hat-3 mr-2"></i> -->
                  Î∞∞Í≤Ω ÏÇ¨ÏßÑ
                </h2>
              </b-col>
              <b-col>
                <h3>Ïó¨Í∏∞Ïóê Î∞∞Í≤Ω ÏÇ¨ÏßÑ ÌååÏùº Î™Ö</h3>
                <!-- <ProfileImg/> -->
              </b-col>
              <b-col>
                <div>
                  <b-button size="sm" @click="modalShow = !modalShow"
                    >ÏÇ¨ÏßÑüì∑</b-button
                  >

                  <b-modal v-model="modalShow" hide-footer>
                    <template #modal-title>
                      <h1>ÌîÑÎ°úÌïÑ ÏóÖÎ°úÎìú</h1>
                    </template>
                    <div>
                      <b-form-file
                        v-model="file1"
                        placeholder="Choose a file or drop it here..."
                        drop-placeholder="Drop file here..."
                      ></b-form-file>
                      <div class="mt-3">
                        Selected file: {{ file1 ? file1.name : "" }}
                      </div>
                    </div>
                    <div class="text-center">
                      <base-button
                        type="primary"
                        native-type="submit"
                        class="my-4"
                        @click="uploadHandler"
                        >ÌôïÏù∏</base-button
                      >
                    </div>
                  </b-modal>
                </div>
              </b-col>
            </b-row>

            <hr class="my-4" />
            <b-row class="justify-content-end">
              <b-button
                variant="danger"
                class="mt-4 mr-4"
                @click="withDrawal"
                size="sm"
                >ÌöåÏõêÌÉàÌá¥</b-button
              >
            </b-row>
            <b-row class="justify-content-center">
              <b-button
                variant="primary"
                class="mt-4"
                size="lg"
                @click="updateHandler"
                >Ï†ïÎ≥¥ÏàòÏ†ï</b-button
              >
            </b-row>
          </b-container>
        </b-card-body>
      </b-card>
    </b-container>
  </div>
</template>
<script>
// import EditProfileForm from './UserProfile/EditProfileForm.vue';
import UserCard from "./UserProfile/UserCard.vue";
import LoginContent from "@/components/Login/LoginContent.vue";
import FlavourContent from "@/components/Profileupdate/FlavourContent.vue";
// import ProfileImg from '@/components/Profileupdate/ProfileImg.vue';
// import BackgroundImg from "@/components/Profileupdate/BackgroundImg.vue";

export default {
  components: {
    // EditProfileForm,
    UserCard,
    LoginContent,
    FlavourContent
    // ProfileImg,
    // BackgroundImg
  },
  data() {
    return {
      nickname: "",
      introduction:
        "Ïà†ÏûîÏùÑ Îì§ÏûêÌïòÎãà Ï≤úÌïòÍ∞Ä ÎÇ¥Î∞úÏïÑÎûò ÏûàÍ≥† 6ÌåÄ ÏπúÍµ¨Îì§ ÎòêÌïú ÏòÜÏóê ÏûàÏúºÎãà ÏóºÎùºÎåÄÏôï ÎëêÎ†µÏßÄ ÏïäÍµ¨ÎÇò",
      address: "https://github.com",
      profileImg: "",
      backImg: "",
      keywords: [],
      keywordtexts: [],
      options: [],
      follower: "",
      following: "",
      boards: "",
      comments: "",
      major: "",
      email: "",
      modalShow: false,
      file1: null,
      files: [],
      uid: "",
      profileURL: ""
    };
  },
  computed: {
    rqprofileURL: function() {
      return require(this.profileURL);
    }
  },
  created() {
    this.uid = this.$store.getters.getUid;
    this.profileURL = `(${this.$store.getters.getServer}/user/image/${this.uid})`;
    axios
      .get(`${this.$store.getters.getServer}/user/info`)
      .then(res => {
        console.log(res.data);
        this.nickname = res.data.name;
        this.email = res.data.email;
        this.keywords = res.data.keywords;
        this.keywordtexts = res.data.keywordtexts;
      })
      .catch(() => {
        alert("Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌïú ÏÑúÎπÑÏä§ÏûÖÎãàÎã§.");
        this.$store.dispatch("LOGOUT").then(() => {
          this.$router.replace("/");
        });
      });
    axios.get(`${this.$store.getters.getServer}/keyword/list`).then(res => {
      this.options = res.data.keywords;
    });
  },
  methods: {
    withDrawal() {
      axios
        .delete(`${this.$store.getters.getServer}/user/withdraw`)
        .then(() => {
          alert("ÌöåÏõê ÌÉàÌá¥Í∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.");
          this.$store.dispatch("LOGOUT").then(() => {
            this.$router.replace("/main");
          })
        })
        .catch(() => {
          alert("Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.");
        });
    },
    changeFlavour(keywords) {
      // Îã§Ïù¥Î†âÌä∏Î°ú ÎÑ£Í∏∞
      console.log(keywords)
      let tempkeywordtexts = new Array(keywords.length)
      for (let i=0; i < keywords.length; i++) {
        tempkeywordtexts[i] = this.options[keywords[i]-1].word
      }
      this.keywordtexts = tempkeywordtexts
      this.keywords = keywords
    },
    updateHandler() {
      // Î≥¥ÎÇºÎïå Î™ÖÎ™ÖÏù¥ Ï§ëÏöîÌï®
      let user = {
        name: this.nickname,
        address: this.address,
        major: this.major,
        keyword: this.keywords,
        introduction: this.introduction,
        file: this.file1
      };
      //console.log("updateHandler : " + user);
      axios
        .put(`${this.$store.getters.getServer}/user/modify`, user)
        .then(res => {
          console.log(res.data);
          if (res.data.msg == "success") {
            alert("ÌöåÏõê ÏàòÏ†ïÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.");
            this.$router.push("/profile");
          } else alert("ÌöåÏõê ÏàòÏ†ï Ïãú Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌñàÏä¥Îã§");
        });
    },
    async uploadHandler() {
      this.modalShow = false;
      var formData = new FormData();
      formData.append("file", this.file1);
      // var photoFile = document.getElementById("photo");
      // frm.append("photo", photoFile.files[0]);

      // this.modalShow = false;
      //console.log("upload ÏãúÏûë ");
      //console.log(this.files);

      await axios
        .post(`${this.$store.getters.getServer}/user/pic`, formData, {
          headers: { "content-type": "multipart/form-data" }
        })
        .then(res => {
          //console.log("upload ÏÑ±Í≥µ ");
          //console.log(res.data.path);
          this.profileURL = `${this.$store.getters.getServer}/user/image/${this.uid}`;
        });
    }
  }
};
</script>
<style></style>
